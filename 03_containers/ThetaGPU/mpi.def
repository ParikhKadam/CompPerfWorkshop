Bootstrap: docker
From: ubuntu:20.04

%files
	source/* /usr/source/
	submit.sh /usr/

%environment
	export PATH=$PATH:/mpich/install/bin
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mpich/install/lib

%post
	#### INSTALL BASE PACKAGES NEEDED FOR MPI APPLICATIONS AND PYTHON3 ####
	DEBIAN_FRONTEND=noninteractive
	apt-get update -y \
	&& DEBIAN_FRONTEND=noninteractive \
	&& apt-get install -y build-essential libfabric-dev libibverbs-dev gfortran wget \
	&& apt-get install -y python3 python3-distutils python3-pip gcc

	#### DOWNLOAD AND INSTALL MPICH AND MPI4PY ####
	# Source is available at http://www.mpich.org/static/downloads/
	# See installation guide of target MPICH version
	# Ex: https://www.mpich.org/static/downloads/4.0.2/mpich-4.0.2-installguide.pdf
	# These options are passed to the steps below
	MPICH_VERSION="3.3"
	MPICH_CONFIGURE_OPTIONS="--prefix=/mpich/install --disable-wrapper-rpath"
	MPICH_MAKE_OPTIONS="-j 4"
	mkdir -p mpich \
	&& cd /mpich \
	&& wget http://www.mpich.org/static/downloads/${MPICH_VERSION}/mpich-${MPICH_VERSION}.tar.gz \
	&& tar xfz mpich-${MPICH_VERSION}.tar.gz  --strip-components=1 \
	&& ./configure ${MPICH_CONFIGURE_OPTIONS} \
	&& make install ${MPICH_MAKE_OPTIONS}
	
	export PATH=$PATH:/mpich/install/bin
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mpich/install/lib

	pip install mpi4py

	#### BUILD FILES ####
	chmod +x /usr/submit.sh
	mpicc -o /usr/source/mpi_hello_world /usr/source/mpi_hello_world.c

%runscript
	exec /usr/submit.sh "$@"

%labels
    MAINTAINER Aditya atanikanti@anl.gov

%help
    This is container is used to illustrate a mpi based def file to build a container running python and c programs. 
	To build the container use singularity build --fakeroot mpi.sif mpi.def
